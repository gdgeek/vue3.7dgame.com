import{b5 as e,d as a,r as t,aF as s,c as r,a8 as n,o,aA as i,ab as l,e as u,h as c,l as d,w as p,bq as v,Z as m,g as y,f,B as g,a1 as h,a0 as b,b8 as w,bs as x,aZ as _,aw as O}from"./index.D_6c1BO-.js";import{v as k}from"./el-loading.DBavWlYX.js";/* empty css                        */import{b as J,c as N}from"./meta.B4p9iP3P.js";const S={class:"verse-code"},j={class:"clearfix"},C=["src"],E=O(a({__name:"script",setup(a){let O=!1;const E=t(null),L=async a=>{if(null===I.value)return void i({message:"没有元信息",type:"error"});if(!I.value.editable)return void i({message:"没有编辑权限",type:"error"});const t=I.value.cyber;if(await N(I.value.id,{blockly:a.data,lua:a.script}),t){const s=await((a,t)=>e({url:"v1/cybers/"+a,method:"put",data:t}))(t.id,{data:JSON.stringify(a.data),script:a.script});I.value.cyber=s.data}else{const t=await(s={meta_id:I.value.id,data:JSON.stringify(a.data),script:a.script},e({url:"v1/cybers",method:"post",data:s}));I.value.cyber=t.data}var s;i({message:"保存成功",type:"success"})},q=async e=>{try{if(!e.data.action)return;const a=e.data;"ready"===a.action?(O=!0,F()):"post"===a.action?await L(a.data):"post:no-change"===a.action&&i({message:"没有修改",type:"info"})}catch(a){return}},z=t(!1),I=t(null),W=s(),Z=r((()=>parseInt(W.query.id))),A=()=>{B("save")},B=(e,a={})=>{E.value&&E.value.contentWindow?E.value.contentWindow.postMessage({from:"script.meta.web",action:e,data:JSON.parse(JSON.stringify(a))},"*"):i({type:"error"})},F=()=>{var e,a;if(!I.value)return;if(!O)return;const t=(null==(e=I.value.metaCode)?void 0:e.blockly)?JSON.parse(null==(a=I.value.metaCode)?void 0:a.blockly):{};B("init",{language:["lua","js"],style:["base","meta"],data:t,parameters:{index:I.value.id,resource:D(I.value)}})},K=(e,a)=>a.find((a=>e.type.toLowerCase()===a.toLowerCase()))?{uuid:e.parameters.uuid,name:e.parameters.name??null}:void 0,M=(e,a)=>{const t=(e=>{if(e&&e.parameters&&void 0!==e.parameters)return{uuid:e.parameters.uuid,name:e.parameters.action??null,parameter:e.parameters.parameter??null}})(e);t&&a.action.push(t);const s=K(e,["polygen","entity","voxel","video","picture","text","voxel"]);s&&a.entity.push(s);const r=K(e,["polygen"]);r&&a.polygen.push(r);const n=K(e,["video"]);n&&a.video.push(n);const o=K(e,["picture"]);o&&a.picture.push(o);const i=K(e,["sound"]);i&&a.sound.push(i);const l=K(e,["text"]);l&&a.text.push(l);const u=K(e,["voxel"]);u&&a.voxel.push(u),e.children&&Object.keys(e.children).forEach((t=>{e.children[t].forEach((e=>{M(e,a)}))}))},D=e=>{const a=JSON.parse(e.data),t={action:[],trigger:[],polygen:[],picture:[],video:[],voxel:[],text:[],sound:[],entity:[],events:{inputs:[],outputs:[]}};return t.events=JSON.parse(e.events)||{inputs:[],outputs:[]},M(a,t),t};return n((()=>{window.removeEventListener("message",q)})),o((async()=>{window.addEventListener("message",q);try{z.value=!0;const e=await J(Z.value,"cyber,event,share,metaCode");I.value=e.data,F()}catch(e){i({message:e.message,type:"error"})}finally{z.value=!1}})),(e,a)=>{const t=l("font-awesome-icon"),s=b,r=w,n=x,o=v,i=_,O=k;return u(),c("div",S,[d(o,null,{default:p((()=>[d(n,null,{default:p((()=>[m((u(),f(i,{class:"box-card"},{header:p((()=>[g("div",j,[h(" / 【script】 "),d(r,{style:{float:"right"}},{default:p((()=>[d(s,{type:"primary",size:"small",onClick:A},{default:p((()=>[d(t,{class:"icon",icon:"save"}),h(" 保存 ")])),_:1})])),_:1})])])),default:p((()=>[d(o,null,{default:p((()=>[d(n,{style:{margin:"0",padding:"0",height:"70vh"}},{default:p((()=>[g("iframe",{style:{margin:"0",padding:"0",height:"100%",width:"100%"},id:"editor",ref_key:"editor",ref:E,src:y("https://blockly.4mr.cn")},null,8,C)])),_:1})])),_:1})])),_:1})),[[O,y(z)]])])),_:1})])),_:1})])}}}),[["__scopeId","data-v-c69b2f92"]]);export{E as default};
