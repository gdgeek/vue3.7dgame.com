import{d as e,r as a,c as l,o,a8 as t,e as i,f as r,w as n,a1 as s,D as u,B as d,l as c,h as p,p as m,aZ as f,a0 as v,bo as g,g as y,aR as b,aA as _,Y as x,b8 as h,aP as k,aQ as w,aw as j,aD as C,P as V,ab as z,d7 as M,d8 as S}from"./index.D_6c1BO-.js";/* empty css                        */import{b as P,d as T,a as U}from"./verse.BXoeVNCC.js";import{E as B}from"./el-dialog.BAFVqCLi.js";/* empty css                   */import{Q as E}from"./qrcode.vue.esm.CmwFyltj.js";import{a as R,E as N}from"./el-form.Dzvhq0L7.js";/* empty css                 */import"./el-form-item.l0sNRNKZ.js";import{M as H,E as I}from"./vue-cropper.es.ChtapvH5.js";import"./el-progress.LtfRqGX4.js";import{p as L}from"./files.D66WF0_8.js";import{E as F}from"./index.D3735v7o.js";import{E as O}from"./index.sgqfUYPi.js";import{E as q}from"./el-link.D88YWF2f.js";import{a as D}from"./wordpress.eOt7bANc.js";import{p as J}from"./purify.es.DQ6a-d5V.js";const W={key:0,style:{"margin-bottom":"20px","font-size":"20px","font-weight":"700"}},G={class:"dialog-footer"},Q=e({__name:"MrPPQRcodeVerse",setup(e,{expose:g}){const y=a(!1),b=a("https://mrpp.com"),_=a(400),x=a(null),h=l((()=>{var e;return(null==(e=x.value)?void 0:e.id)??-1})),k=l((()=>x.value?`请用设备扫描二维码，进入【${x.value.name}】。`:"请用设备扫描二维码，进入场景。")),w=e=>-1!==e?j(e).toString().padStart(6,"0").split("").reverse().join(""):"",j=e=>{let a=0;for(let l=0;l<18;l++)a<<=1,a|=1&e,e>>=1;return a>>>0},C=()=>{_.value=Math.min(500,.8*window.innerWidth-80)};return o((()=>{C(),window.addEventListener("resize",C)})),t((()=>{window.removeEventListener("resize",C)})),g({open:async e=>{const a={projectId:e,veri:"MrPP.com"};b.value=JSON.stringify(a),y.value=!0;const l=await P(e);x.value=l.data}}),(e,a)=>{const l=f,o=v,t=B;return i(),r(t,{"append-to-body":"",modelValue:y.value,"onUpdate:modelValue":a[1]||(a[1]=e=>y.value=e),width:"80%","close-on-click-modal":!1},{header:n((()=>[s(u(k.value),1)])),footer:n((()=>[d("span",G,[c(o,{onClick:a[0]||(a[0]=e=>y.value=!1)},{default:n((()=>[s("取 消")])),_:1})])])),default:n((()=>[c(l,{class:"box-card",style:{"text-align":"center"}},{default:n((()=>[-1!==h.value?(i(),p("div",W,u(w(h.value)),1)):m("",!0),c(E,{value:w(h.value),size:_.value,level:"H"},null,8,["value","size"])])),_:1})])),_:1},8,["modelValue"])}}}),$=["src"],A={key:1,class:"el-icon-plus file-uploader-icon"},K=(e=>(k("data-v-12e29e1c"),e=e(),w(),e))((()=>d("span",null,"头像截取",-1))),Y={class:"cropper-content"},Z={class:"cropper",style:{"text-align":"center"}},X=j(e({__name:"MrPPCropper",props:{imageUrl:{},fileName:{}},emits:["saveFile"],setup(e,{emit:l}){const o=e,t=l,r=a(null),u=g(),m=a(null),f=a(!1),k=a(!1),w=a({img:"",info:!0,outputSize:1,outputType:"jpeg",canScale:!0,autoCrop:!0,canMove:!0,canMoveBox:!0,autoCropWidth:300,autoCropHeight:300,fixedBox:!1,fixed:!0,fixedNumber:[1,1],full:!1,original:!1,centerBox:!0,infoTrue:!0});m.value=o.imageUrl;const j=async e=>{const a=e.raw;if(a){const e=["image/jpeg","image/png","image/bmp","image/gif"].includes(a.type),l=a.size/1024/1024<2;if(!e)return _.error("上传头像图片只能是 JPG/PNG/BMP/GIF 格式!"),!1;if(!l)return _.error("上传头像图片大小不能超过 2MB!"),!1;await x(),w.value.img=URL.createObjectURL(a),k.value=!1,f.value=!0}else _.error("请选择有效的文件！")},C=e=>{var a;e=e||1,null==(a=r.value)||a.changeScale(e)},V=()=>{var e;null==(e=r.value)||e.rotateLeft()},z=()=>{var e;null==(e=r.value)||e.rotateRight()},M=e=>{},S=async()=>{var e;null==(e=r.value)||e.getCropBlob((async e=>{const a=o.fileName,l=new File([e],a,{type:"image/jpeg"});l.extension=".jpg";const i=await u.store.fileMD5(l),r=await u.store.publicHandler();await u.store.fileHas(i,l.extension,r,"backup")||await u.store.fileUpload(i,l.extension,l,(e=>{}),r,"backup"),await(async(e,a,l,o)=>{const i={filename:l.name,md5:e,key:e+a,url:u.store.fileUrl(e,a,o,"backup")};m.value=i.url;try{const e=await L(i);t("saveFile",e.data.id)}catch(r){}k.value=!1})(i,l.extension,l,r),f.value=!1,k.value=!0}))};return(e,a)=>{const l=I,o=v,t=h,u=B;return i(),p("div",null,[c(l,{class:"file-uploader",action:"","auto-upload":!1,"show-file-list":!1,"on-change":j,accept:"image/jpeg,image/gif,image/png,image/bmp",style:{float:"left"}},{default:n((()=>[y(m)?(i(),p("img",{key:0,src:y(m),class:"file"},null,8,$)):(i(),p("i",A))])),_:1}),c(u,{modelValue:y(f),"onUpdate:modelValue":a[3]||(a[3]=e=>b(f)?f.value=e:null),class:"crop-dialog","append-to-body":""},{header:n((()=>[K])),footer:n((()=>[c(t,{style:{float:"left"}},{default:n((()=>[c(o,{size:"small",type:"primary",plain:"",onClick:V},{default:n((()=>[s(" 左旋转 ")])),_:1}),c(o,{size:"small",type:"primary",plain:"",onClick:z},{default:n((()=>[s(" 右旋转 ")])),_:1}),c(o,{size:"small",type:"primary",plain:"",onClick:a[0]||(a[0]=e=>C(1))},{default:n((()=>[s(" 放大 ")])),_:1}),c(o,{size:"small",type:"primary",plain:"",onClick:a[1]||(a[1]=e=>C(-1))},{default:n((()=>[s(" 缩小 ")])),_:1})])),_:1}),c(t,null,{default:n((()=>[c(o,{onClick:a[2]||(a[2]=e=>f.value=!1)},{default:n((()=>[s("取消")])),_:1}),c(o,{type:"primary",loading:y(k),onClick:S},{default:n((()=>[s(" 确认 ")])),_:1},8,["loading"])])),_:1})])),default:n((()=>[d("div",Y,[d("div",Z,[c(y(H),{ref_key:"cropperRef",ref:r,img:y(w).img,"output-size":y(w).outputSize,"output-type":y(w).outputType,info:!0,full:y(w).full,"can-move":y(w).canMove,"can-move-box":y(w).canMoveBox,original:y(w).original,"auto-crop":y(w).autoCrop,fixed:y(w).fixed,"fixed-number":y(w).fixedNumber,"center-box":y(w).centerBox,"info-true":y(w).infoTrue,"fixed-box":y(w).fixedBox,"auto-crop-width":y(w).autoCropWidth,"auto-crop-height":y(w).autoCropHeight,onCropMoving:M},null,8,["img","output-size","output-type","full","can-move","can-move-box","original","auto-crop","fixed","fixed-number","center-box","info-true","fixed-box","auto-crop-width","auto-crop-height"])])])])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-12e29e1c"]]),ee={class:"dialog-footer"},ae=e({__name:"MrPPVerseWindowCreate",props:{dialogTitle:{type:String,default:"选择文件"},dialogSubmit:{type:String,default:"确定"}},emits:["submit"],setup(e,{expose:o,emit:t}){const p=e,f=t,g=a(!1),x=a(null),h=a(null),k=l((()=>C().userInfo.roles.includes("manager"))),w=a({url:"",name:"",description:"",course:-1}),j={name:[{required:!0,message:"请输入活动名称",trigger:"blur"},{min:3,max:64,message:"长度在 3 到 64 个字符",trigger:"blur"}]};V((()=>{if(h.value){w.value.name=h.value.name,w.value.url=h.value.image.url;const e=JSON.parse(h.value.info);null!==e&&(w.value.description=e.description,w.value.course=e.course)}}));const z=a(),M=async()=>{var e;null==(e=z.value)||e.validate((e=>{e?f("submit",w.value,h.value,x.value):_.error("表单验证失败")}))},S=e=>{x.value=e};return o({show:e=>{h.value=e,h.value&&setTimeout((()=>{a(null).value=h.value.image.url}),0),g.value=!0},hide:()=>{g.value=!1}}),(a,l)=>{const o=R,t=F,f=N,_=v,x=B;return i(),r(x,{modelValue:y(g),"onUpdate:modelValue":l[4]||(l[4]=e=>b(g)?g.value=e:null),"append-to-body":"","close-on-click-modal":!1,width:"70%"},{header:n((()=>[s(u(e.dialogTitle),1)])),footer:n((()=>[d("span",ee,[c(_,{onClick:l[3]||(l[3]=e=>g.value=!1)},{default:n((()=>[s("取 消")])),_:1}),c(_,{type:"primary",onClick:M},{default:n((()=>[s(u(p.dialogSubmit),1)])),_:1})])])),default:n((()=>[c(f,{ref_key:"formRef",ref:z,rules:j,model:y(w),"label-width":"80px"},{default:n((()=>[c(o,{label:"封面图片"},{default:n((()=>[c(X,{ref:"image","image-url":y(w).url,"file-name":"verse.picture",onSaveFile:S},null,8,["image-url"])])),_:1}),c(o,{prop:"name",label:"名称"},{default:n((()=>[c(t,{modelValue:y(w).name,"onUpdate:modelValue":l[0]||(l[0]=e=>y(w).name=e)},null,8,["modelValue"])])),_:1}),c(o,{label:"内容说明"},{default:n((()=>[c(t,{modelValue:y(w).description,"onUpdate:modelValue":l[1]||(l[1]=e=>y(w).description=e),type:"textarea"},null,8,["modelValue"])])),_:1}),y(k)?(i(),r(o,{key:0,label:"绑定教程"},{default:n((()=>[c(t,{modelValue:y(w).course,"onUpdate:modelValue":l[2]||(l[2]=e=>y(w).course=e),type:"number"},null,8,["modelValue"])])),_:1})):m("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue"])}}}),le=e({__name:"MrPPVerseToolbar",props:{verse:{}},emits:["deleted","changed"],setup(e,{emit:o}){const t=e,u=o,d=a(null),f=a(null),g=l((()=>!!t.verse&&t.verse.editable)),b=l((()=>!!t.verse&&t.verse.editable)),x=()=>{f.value&&t.verse&&f.value.open(t.verse.id)},k=async()=>{try{await O.confirm("此操作将永久销毁此【宇宙】, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",closeOnClickModal:!1,type:"warning"}),await w()}catch{_({type:"info",message:"已取消删除"})}},w=async()=>{if(t.verse)try{await T(t.verse.id),_({type:"success",message:"删除成功!"}),u("deleted",t.verse)}catch(e){}},j=async(e,a,l)=>{if(t.verse){const a={name:e.name,info:JSON.stringify(e)};null!==l&&(a.image_id=l);try{const e=await U(t.verse.id,a);_({type:"success",message:"修改成功!"}),d.value&&d.value.hide(),u("changed",e.data)}catch(o){}}},C=()=>{d.value&&t.verse&&d.value.show(t.verse)};return(e,a)=>{const l=z("font-awesome-icon"),o=v,t=h;return i(),p("span",null,[c(ae,{ref_key:"changedDialog",ref:d,"dialog-title":"修改数据","dialog-submit":"修 改",onSubmit:j},null,512),c(Q,{ref_key:"qrcodeRef",ref:f},null,512),e.verse?(i(),r(t,{key:0,style:{float:"right"},inline:!0},{default:n((()=>[c(o,{type:"info",size:"small",onClick:x},{default:n((()=>[c(l,{icon:"qrcode"})])),_:1}),y(b)?(i(),r(o,{key:0,type:"success",size:"small",icon:"Edit",onClick:C})):m("",!0),y(g)?(i(),r(o,{key:1,type:"danger",size:"small",icon:"delete",onClick:k})):m("",!0),s("   ")])),_:1})):m("",!0)])}}}),oe=j(e({__name:"InfoContent",props:{info:{},author:{}},setup(e){const t=e,d=a(null),f=l((()=>d.value?J.sanitize(d.value.title.rendered):""));return o((async()=>{var e;if((null==(e=t.info)?void 0:e.course)&&-1!==t.info.course)try{const e=await D(t.info.course);d.value=e.data}catch(a){}})),(e,a)=>{const l=z("font-awesome-icon"),o=M,t=q,v=z("router-link"),g=S;return i(),p("div",null,[c(g,{"label-class-name":"info-content-label",column:1,size:"small",border:""},{default:n((()=>{var a;return[e.author?(i(),r(o,{key:0},{label:n((()=>[c(l,{class:"icon",icon:"user"}),s(" 作者 ")])),default:n((()=>[s(" "+u(e.author.nickname||e.author.username),1)])),_:1})):m("",!0),(null==(a=d.value)?void 0:a.title)?(i(),r(o,{key:1},{label:n((()=>[c(l,{class:"icon",icon:"book"}),s(" 学习 ")])),default:n((()=>[c(v,{target:"_blank",to:`/home/document?id=${d.value.id}`},{default:n((()=>[c(t,{target:"_blank",innerHTML:y(f)},{default:n((()=>[s(" 默认链接 ")])),_:1},8,["innerHTML"])])),_:1},8,["to"])])),_:1})):m("",!0),e.info.description?(i(),r(o,{key:2},{label:n((()=>[c(l,{class:"icon",icon:"info"}),s(" 说明 ")])),default:n((()=>[s(" "+u(e.info.description),1)])),_:1})):m("",!0)]})),_:1})])}}}),[["__scopeId","data-v-d88083e3"]]);export{oe as I,le as _,ae as a};
